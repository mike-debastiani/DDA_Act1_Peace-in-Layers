<!DOCTYPE html>
<html lang="en">
  <head>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:ital,wdth,wght@0,75..100,100..700;1,75..100,100..700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../GlobalStyles.css">
    <link rel="stylesheet" href="datavis.css">
  </head>

  <body>
    <!-- HEADER -->
    <header class="header-container">
      <h1 class="header-title">Layers of Peace</h1>
      
      <div class="header-buttons">
        <a href="../intro.html" class="header-btn header-btn-inactive">
          <img src="../src/icons/introIcon.svg" alt="Intro" class="header-btn-icon-intro" />
          Intro
        </a>
        <a href="../index.html" class="header-btn header-btn-inactive">
          <img src="../src/icons/communityIcon.svg" alt="Communities" class="header-btn-icon-community" />
          Communities
        </a>
        <div class="datavis-dropdown">
          <a href="#" class="header-btn header-btn-active" id="datavisDropdownBtn">
            <img src="../src/icons/datavisIconWhite.svg" alt="Datavis" class="header-btn-icon-large" />
            Datavis
          </a>
          <div class="datavis-dropdown-content" id="datavisDropdownContent">
            <a href="datavis.html?community=potoci" class="datavis-dropdown-item">Potoci</a>
            <a href="datavis.html?community=zalik" class="datavis-dropdown-item">Zalik</a>
            <a href="datavis.html?community=cim" class="datavis-dropdown-item">Cim</a>
            <a href="datavis.html?community=cernica" class="datavis-dropdown-item">Cernica</a>
            <a href="datavis.html?community=bijeli-brijeg" class="datavis-dropdown-item">Bijeli Brijeg</a>
            <a href="datavis.html?community=podhum" class="datavis-dropdown-item">Podhum</a>
            <a href="datavis.html?community=blagaj" class="datavis-dropdown-item">Blagaj</a>
          </div>
        </div>
        
        <div class="menu-toggle">
          <div class="menu-container" id="menuContainer">
            <button class="menu-button" id="menuToggleBtn">
              <img src="../src/icons/hamburgerIcon.svg" alt="Menu" class="header-btn-icon-menu" />
            </button>

            <div class="menu-content">
              <a href="#" class="menu-item">Home</a>
              <a href="#" class="menu-item">Credits</a>
              <div class="menu-item-with-arrow">
                <a href="#" class="menu-item">Language</a>
                <img src="../src/icons/dropdownArrowIcon.svg" alt="Dropdown" style="width: 16px; height: 9px" />
              </div>
            </div>

            <img src="../src/icons/closeIcon.svg" alt="Close" class="menu-close" id="menuCloseBtn" />
          </div>
        </div>
      </div>
    </header>

    <div class="main-content">
      <div class="content-container">
      <!-- SIDEBAR -->
      <aside class="panel" id="panel">
        <div class="panelScroll">
          <!-- TOP TITLE ROW -->
          <div class="titleTop">
            <h1 id="pageTitle">Community Data</h1>

            <div class="votesHeaderWrap" id="votesHeaderWrap">
              <button
                class="votesHeaderBtn right"
                id="votesHeaderBtn"
                type="button"
                title="Highlight all votes"
              >
                <span id="totalVotesHead" class="topVotesNumber">0</span>
                <span class="metaLabel">total votes</span>
              </button>
            </div>
          </div>

          <!-- INDICATORS SECTION -->
          <section class="section" id="sectionIndicators">
            <div class="sectionHead">
              <div class="leftHead">
                <div class="titleLine">
                  <h3>
                    Indicators
                    <span id="indCount" class="count"></span>
                  </h3>
                </div>
              </div>

              <button
                class="btn btn-show-all"
                id="toggleInd"
                aria-expanded="false"
              >
                <span class="toggle-text" id="indToggleText">show all</span>
                <img src="../src/icons/dropdownArrowIcon.svg" alt="Dropdown" class="btn-icon toggle-arrow" style="width: 17px; height: 9px;">
              </button>
            </div>

            <div id="indWrap">
              <ul class="indList" id="indicatorList"></ul>
            </div>
          </section>

          <!-- SUBCATEGORIES SECTION -->
          <section class="section" id="sectionSubcats">
            <div class="sectionHead">
              <div class="leftHead">
                <div class="titleLine">
                  <h3>
                    Subcategories
                    <span id="subCount" class="count"></span>
                  </h3>
                </div>
              </div>

              <button
                class="btn btn-show-all"
                id="toggleSub"
                aria-expanded="false"
              >
                <span class="toggle-text" id="subToggleText">show all</span>
                <img src="../src/icons/dropdownArrowIcon.svg" alt="Dropdown" class="btn-icon toggle-arrow" style="width: 17px; height: 9px;">
              </button>
            </div>

            <div id="subsWrap">
              <div id="subPills"></div>
            </div>
          </section>

          <!-- CATEGORIES SECTION -->
          <section class="section" id="sectionCats">
            <div class="sectionHead">
              <div class="leftHead">
                <div class="titleLine">
                  <h3>
                    Categories
                    <span id="catCount" class="count"></span>
                  </h3>
                </div>
              </div>

              <button
                class="btn btn-show-all"
                id="toggleCat"
                aria-expanded="false"
              >
                <span class="toggle-text" id="catToggleText">show all</span>
                <img src="../src/icons/dropdownArrowIcon.svg" alt="Dropdown" class="btn-icon toggle-arrow" style="width: 17px; height: 9px;">
              </button>
            </div>

            <div id="catsWrap">
              <div id="catPills"></div>
            </div>
          </section>

          <!-- DIMENSIONS SECTION -->
          <section class="section" id="sectionDims">
            <div class="sectionHead">
              <div class="leftHead">
                <div class="titleLine">
                  <h3>
                    Dimensions
                    <span id="dimCount" class="count"></span>
                  </h3>
                </div>
              </div>

              <button
                class="btn btn-show-all"
                id="toggleDim"
                aria-expanded="false"
              >
                <span class="toggle-text" id="dimToggleText">show all</span>
                <img src="../src/icons/dropdownArrowIcon.svg" alt="Dropdown" class="btn-icon toggle-arrow" style="width: 17px; height: 9px;">
              </button>
            </div>

            <div id="dimsWrap">
              <div id="dimPills"></div>
            </div>
          </section>
        </div>
      </aside>

      <!-- CANVAS AREA -->
      <div class="canvasWrap" id="p5-wrap">
        <div class="layerBadge" id="selectedLayerDisplay">
          <span class="layerBadgeLabel">Selected Layer:</span>
          <span class="layerBadgeValue" id="selectedLayerValue">None</span>
        </div>

        <button id="zoomBtn" class="zoomBtn">Zoom</button>
      </div>
      </div>

      <!-- BOTTOM BUTTONS -->
      <div class="bottom-controls">
        <div class="bottom-controls-left">
          <button id="helpBtn" class="help-btn">
            <span class="help-icon">?</span>
          </button>
          <button id="clearBtn" class="clearBtn">
            <img src="../src/icons/closeIconWhite.svg" alt="Clear Selection" class="btn-icon" style="width: 18px; height: 18px" />
            Clear Selection
          </button>
        </div>
        <div class="bottom-controls-right">
          <div class="zoom-controls">
            <button class="zoom-step active" data-zoom="1">1x</button>
            <button class="zoom-step" data-zoom="2">2x</button>
            <button class="zoom-step" data-zoom="3">3x</button>
          </div>
        </div>
      </div>
    </div>

    <!-- HELP OVERLAY -->
    <div id="helpOverlay" class="help-overlay">
      <div class="help-overlay-content">
        <button id="closeHelpBtn" class="close-help-btn">
          <img src="../src/icons/closeIcon.svg" alt="Close" class="close-icon" />
          Close explanation
        </button>
        <div class="help-image-container">
          <img src="../assets/images/DataExpl.svg" alt="Data Explanation" class="help-image" />
        </div>
      </div>
    </div>

    <!-- LIBRARIES -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.3/p5.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.9.0/d3.min.js"></script>

    <!-- MAIN SKETCH -->
    <script src="sketch.js"></script>
    
    <!-- HEADER FUNCTIONALITY -->
    <script>
      console.log('Script started loading...');
      
      document.addEventListener('DOMContentLoaded', function() {
        console.log('DOM Content Loaded!');
        
        // Add expanding menu functionality
        const menuToggleBtn = document.getElementById('menuToggleBtn');
        const menuContainer = document.getElementById('menuContainer');
        const menuCloseBtn = document.getElementById('menuCloseBtn');
        
        // Toggle menu expansion on hamburger click
        menuToggleBtn.addEventListener('click', function(e) {
          e.stopPropagation();
          menuContainer.classList.toggle('expanded');
        });
        
        // Close menu on close button click
        menuCloseBtn.addEventListener('click', function(e) {
          e.stopPropagation();
          menuContainer.classList.remove('expanded');
        });
        
        // Close menu when clicking outside
        document.addEventListener('click', function(e) {
          if (!menuContainer.contains(e.target)) {
            menuContainer.classList.remove('expanded');
          }
        });

        // Back to Communities functionality
        const backToCommunitiesBtn = document.getElementById('backToCommunitiesBtn');
        if (backToCommunitiesBtn) {
          backToCommunitiesBtn.addEventListener('click', function() {
            // Navigate back to index.html
            window.location.href = '../index.html';
          });
        }

        // Datavis Dropdown functionality
        console.log('Setting up datavis dropdown...');
        const datavisDropdownBtn = document.getElementById('datavisDropdownBtn');
        const datavisDropdownContent = document.getElementById('datavisDropdownContent');
        let dropdownTimeout;

        console.log('Datavis elements found:', {
          btn: datavisDropdownBtn,
          content: datavisDropdownContent
        });

        if (datavisDropdownBtn && datavisDropdownContent) {
          console.log('Adding event listeners...');
          datavisDropdownBtn.addEventListener('mouseenter', function() {
            console.log('Mouse enter on datavis button');
            clearTimeout(dropdownTimeout);
            datavisDropdownContent.classList.add('show');
          });

          datavisDropdownBtn.addEventListener('mouseleave', function() {
            console.log('Mouse leave on datavis button');
            dropdownTimeout = setTimeout(function() {
              datavisDropdownContent.classList.remove('show');
            }, 150);
          });

          datavisDropdownContent.addEventListener('mouseenter', function() {
            console.log('Mouse enter on dropdown content');
            clearTimeout(dropdownTimeout);
            datavisDropdownContent.classList.add('show');
          });

          datavisDropdownContent.addEventListener('mouseleave', function() {
            console.log('Mouse leave on dropdown content');
            dropdownTimeout = setTimeout(function() {
              datavisDropdownContent.classList.remove('show');
            }, 150);
          });
          console.log('Event listeners added successfully!');
        } else {
          console.error('Datavis dropdown elements not found!');
        }

        // Mark current community as active in dropdown
        function markCurrentCommunity() {
          const urlParams = new URLSearchParams(window.location.search);
          const currentCommunity = urlParams.get('community');
          
          if (currentCommunity) {
            const dropdownItems = document.querySelectorAll('.datavis-dropdown-item');
            dropdownItems.forEach(item => {
              const href = item.getAttribute('href');
              if (href && href.includes(`community=${currentCommunity}`)) {
                item.classList.add('active');
              } else {
                item.classList.remove('active');
              }
            });
          }
        }

        // Call on page load
        markCurrentCommunity();

        // Help Button functionality
        const helpBtn = document.getElementById('helpBtn');
        const helpOverlay = document.getElementById('helpOverlay');
        const closeHelpBtn = document.getElementById('closeHelpBtn');
        
        if (helpBtn && helpOverlay && closeHelpBtn) {
          // Open overlay when help button is clicked
          helpBtn.addEventListener('click', function() {
            console.log('Help button clicked - opening overlay');
            helpOverlay.classList.add('show');
            // Prevent body scroll when overlay is open
            document.body.style.overflow = 'hidden';
          });

          // Close overlay when close button is clicked
          closeHelpBtn.addEventListener('click', function() {
            console.log('Close help button clicked - closing overlay');
            helpOverlay.classList.remove('show');
            // Restore body scroll
            document.body.style.overflow = '';
          });

          // Close overlay when clicking outside the content
          helpOverlay.addEventListener('click', function(e) {
            if (e.target === helpOverlay) {
              console.log('Overlay background clicked - closing overlay');
              helpOverlay.classList.remove('show');
              // Restore body scroll
              document.body.style.overflow = '';
            }
          });

          // Close overlay with Escape key
          document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && helpOverlay.classList.contains('show')) {
              console.log('Escape key pressed - closing overlay');
              helpOverlay.classList.remove('show');
              // Restore body scroll
              document.body.style.overflow = '';
            }
          });
        } else {
          console.error('Help overlay elements not found!');
        }
      });
    </script>
  </body>
</html>
